<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel-5 | Cluster Patient List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .compact-table {
            font-size: 0.75rem;
        }
        .compact-table th {
            position: sticky;
            top: 0;
            background: #f8fafc;
            z-index: 10;
            padding: 0.5rem 0.5rem;
        }
        .compact-table tbody tr:hover {
            background-color: #f0f9ff;
        }
        .compact-table td {
            padding: 0.5rem 0.5rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        background: '#f8fafc',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background font-sans antialiased text-gray-800 h-screen overflow-hidden">

    <script>
        const SMART_CLUSTER_API = 'https://smart-cluster-engine-196547645490.asia-south1.run.app';
        
        let allPatients = [];
        let filteredPatients = [];
        let currentPage = 1;
        let rowsPerPage = 25;
        let isLoading = false;
        let allClusters = [];

        window.onload = function() {
            console.log('Cluster Patient List loaded');
            
            // Check if cluster_id is in URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const clusterIdFromUrl = urlParams.get('cluster_id');
            
            loadClusters().then(() => {
                if (clusterIdFromUrl) {
                    // Set the dropdown to the cluster from URL
                    document.getElementById('clusterSelect').value = clusterIdFromUrl;
                    
                    const cluster = allClusters.find(c => c.smart_cluster_id === clusterIdFromUrl);
                    updateClusterDetails(cluster);
                    
                    const mapBtn = document.getElementById('showMapBtn');
                    const acceptBtn = document.getElementById('acceptBtn');
                    const rejectBtn = document.getElementById('rejectBtn');
                    
                    // Show map button if it's a GIS cluster
                    if (cluster && cluster.algorithm_type === 'GIS') {
                        mapBtn.classList.remove('hidden');
                    }
                    
                    // Show accept/reject buttons for pending clusters
                    if (cluster && cluster.accept_status === 'Pending') {
                        acceptBtn.classList.remove('hidden');
                        rejectBtn.classList.remove('hidden');
                    }
                    
                    loadClusterPatients(clusterIdFromUrl);
                }
            });
        };

        // --- Data Loading ---
        async function loadClusters() {
            try {
                const response = await fetch(`${SMART_CLUSTER_API}/smart-clusters`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allClusters = data.clusters || [];
                    populateClusterDropdown();
                } else {
                    throw new Error(data.error || 'Failed to load clusters');
                }
            } catch (error) {
                console.error('Error loading clusters:', error);
                showNotification('Error loading clusters: ' + error.message, 'danger');
            }
            return Promise.resolve();
        }

        function populateClusterDropdown() {
            const select = document.getElementById('clusterSelect');
            select.innerHTML = '<option value="">All Clusters</option>';
            
            allClusters.forEach(cluster => {
                const option = document.createElement('option');
                option.value = cluster.smart_cluster_id;
                option.textContent = `${cluster.smart_cluster_id} (${cluster.patient_count} patients)`;
                select.appendChild(option);
            });
        }

        async function loadAllPatients() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                showNotification('Loading all patients from all clusters...', 'primary');
                
                allPatients = [];
                let loadedCount = 0;
                
                for (const cluster of allClusters) {
                    const response = await fetch(`${SMART_CLUSTER_API}/smart-cluster-patients?cluster_id=${cluster.smart_cluster_id}`);
                    const data = await response.json();
                    
                    if (data.success && data.patients) {
                        data.patients.forEach(patient => {
                            allPatients.push({
                                ...patient,
                                cluster_id: cluster.smart_cluster_id,
                                algorithm_type: cluster.algorithm_type,
                                cluster_status: cluster.accept_status
                            });
                        });
                        loadedCount++;
                    }
                }
                
                applyFilters();
                showNotification(`Loaded ${allPatients.length} patients from ${loadedCount} clusters`, 'success');
            } catch (error) {
                console.error('Error loading patients:', error);
                showNotification('Error loading patients: ' + error.message, 'danger');
                allPatients = [];
                applyFilters();
            } finally {
                isLoading = false;
            }
        }

        async function loadClusterPatients(clusterId) {
            if (isLoading) return;
            isLoading = true;
            
            try {
                showNotification('Loading patients...', 'primary');
                
                const response = await fetch(`${SMART_CLUSTER_API}/smart-cluster-patients?cluster_id=${encodeURIComponent(clusterId)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                if (data.success) {
                    const cluster = allClusters.find(c => c.smart_cluster_id === clusterId);
                    allPatients = (data.patients || []).map(patient => ({
                        ...patient,
                        cluster_id: clusterId,
                        algorithm_type: cluster?.algorithm_type || 'N/A',
                        cluster_status: cluster?.accept_status || 'N/A'
                    }));
                    applyFilters();
                    updateClusterDetails(cluster); // Update details with patient data
                    showNotification(`Loaded ${allPatients.length} patients`, 'success');
                } else {
                    throw new Error(data.error || 'Failed to load patients');
                }
            } catch (error) {
                console.error('Error loading patients:', error);
                showNotification('Error loading patients: ' + error.message, 'danger');
                allPatients = [];
                applyFilters();
            } finally {
                isLoading = false;
            }
        }

        function updateClusterDetails(cluster) {
            const panel = document.getElementById('clusterDetailsPanel');
            if (!cluster) {
                panel.classList.add('hidden');
                return;
            }
            
            document.getElementById('detailClusterId').textContent = cluster.smart_cluster_id;
            document.getElementById('detailAlgorithm').textContent = cluster.algorithm_type;
            document.getElementById('detailStatus').textContent = cluster.accept_status;
            // Show actual loaded patient count
            const actualPatientCount = allPatients.filter(p => p.cluster_id === cluster.smart_cluster_id).length;
            document.getElementById('detailPatientCount').textContent = actualPatientCount > 0 ? actualPatientCount : cluster.patient_count;
            
            // Calculate date range from patient data
            if (allPatients.length > 0) {
                const clusterPatients = allPatients.filter(p => p.cluster_id === cluster.smart_cluster_id);
                if (clusterPatients.length > 0) {
                    const dates = clusterPatients.map(p => new Date(p.patient_entry_date)).filter(d => !isNaN(d));
                    if (dates.length > 0) {
                        const minDate = new Date(Math.min(...dates)).toISOString().split('T')[0];
                        const maxDate = new Date(Math.max(...dates)).toISOString().split('T')[0];
                        document.getElementById('detailDateRange').textContent = minDate === maxDate ? minDate : `${minDate} to ${maxDate}`;
                    } else {
                        document.getElementById('detailDateRange').textContent = cluster.original_creation_date || '-';
                    }
                } else {
                    document.getElementById('detailDateRange').textContent = cluster.original_creation_date || '-';
                }
            } else {
                document.getElementById('detailDateRange').textContent = cluster.original_creation_date || '-';
            }
            
            document.getElementById('detailSyndrome').textContent = cluster.primary_syndrome || 'Mixed';
            
            panel.classList.remove('hidden');
        }

        let skipOnChange = false;

        window.onClusterChange = function() {
            if (skipOnChange) return;
            
            const clusterId = document.getElementById('clusterSelect').value;
            const mapBtn = document.getElementById('showMapBtn');
            const acceptBtn = document.getElementById('acceptBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            
            if (clusterId) {
                const cluster = allClusters.find(c => c.smart_cluster_id === clusterId);
                updateClusterDetails(cluster);
                
                // Show map button for GIS clusters
                if (cluster && cluster.algorithm_type === 'GIS') {
                    mapBtn.classList.remove('hidden');
                } else {
                    mapBtn.classList.add('hidden');
                }
                
                // Show accept/reject buttons for pending clusters
                if (cluster && cluster.accept_status === 'Pending') {
                    acceptBtn.classList.remove('hidden');
                    rejectBtn.classList.remove('hidden');
                } else {
                    acceptBtn.classList.add('hidden');
                    rejectBtn.classList.add('hidden');
                }
                
                loadClusterPatients(clusterId);
            } else {
                updateClusterDetails(null);
                mapBtn.classList.add('hidden');
                acceptBtn.classList.add('hidden');
                rejectBtn.classList.add('hidden');
                loadAllPatients();
            }
        }

        // --- Filtering & Search ---
        window.filterTable = function() {
            applyFilters();
        }

        window.applyFilters = function() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const filterAdditionType = document.getElementById('filterAdditionType')?.value || '';
            const filterSex = document.getElementById('filterSex')?.value || '';

            filteredPatients = allPatients.filter(patient => {
                const matchesSearch = !searchTerm || 
                    (patient.unique_id || '').toLowerCase().includes(searchTerm) ||
                    (patient.patient_name || '').toLowerCase().includes(searchTerm) ||
                    (patient.villagename || '').toLowerCase().includes(searchTerm) ||
                    (patient.clini_primary_syn || '').toLowerCase().includes(searchTerm);
                
                const matchesAdditionType = !filterAdditionType || (patient.addition_type || '') === filterAdditionType;
                const matchesSex = !filterSex || (patient.pat_sex || '').toString() === filterSex;

                return matchesSearch && matchesAdditionType && matchesSex;
            });

            currentPage = 1;
            updateTable();
        }

        window.clearFilters = function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterAdditionType').value = '';
            document.getElementById('filterSex').value = '';
            applyFilters();
        }

        window.toggleAdvancedFilter = function() {
            const panel = document.getElementById('advancedFilterPanel');
            panel.classList.toggle('hidden');
        }

        // --- Pagination ---
        window.changeRowsPerPage = function() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            updateTable();
        }

        window.firstPage = function() {
            currentPage = 1;
            updateTable();
        }

        window.prevPage = function() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        window.nextPage = function() {
            const totalPages = Math.ceil(filteredPatients.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        }

        window.lastPage = function() {
            currentPage = Math.ceil(filteredPatients.length / rowsPerPage);
            updateTable();
        }

        // --- Data Operations ---
        window.refreshData = function() {
            const clusterId = document.getElementById('clusterSelect').value;
            if (clusterId) {
                loadClusterPatients(clusterId);
            } else {
                loadAllPatients();
            }
        }

        // --- UI Rendering ---
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            // Check if we have GIS patients to determine village column visibility
            const hasGISPatients = filteredPatients.some(p => p.algorithm_type === 'GIS');
            const villageHeader = document.getElementById('villageHeader');
            
            if (hasGISPatients && filteredPatients.every(p => p.algorithm_type === 'GIS')) {
                // All patients are GIS - hide village column completely
                villageHeader.style.display = 'none';
            } else {
                // Mixed or all ABC - show village column
                villageHeader.style.display = '';
            }
            
            if (filteredPatients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center py-8 text-gray-400">No patients found. Select a cluster or load all.</td></tr>';
                document.getElementById('recordCount').textContent = '0 patients';
                document.getElementById('pageInfo').textContent = '0-0 of 0';
                updatePaginationButtons();
                return;
            }

            // Sort by entry date (newest first)
            filteredPatients.sort((a, b) => {
                const dateA = new Date(a.patient_entry_date || 0);
                const dateB = new Date(b.patient_entry_date || 0);
                return dateB - dateA;
            });

            // Pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredPatients.length);
            const paginatedPatients = filteredPatients.slice(startIndex, endIndex);

            tbody.innerHTML = paginatedPatients.map(patient => {
                const sexMap = { '1': 'Male', '2': 'Female', '3': 'Other' };
                const sex = sexMap[patient.pat_sex] || patient.pat_sex || 'N/A';
                
                // Use backend addition_type as-is
                const correctedAdditionType = patient.addition_type || 'ORIGINAL';
                const correctedExpansionDate = correctedAdditionType === 'EXPANSION' ? patient.patient_entry_date : '-';
                const isGIS = patient.algorithm_type === 'GIS';
                return `
                    <tr class="border-b border-gray-100">
                        <td class="px-2 py-2 font-mono text-xs">${patient.cluster_id || 'N/A'}</td>
                        <td class="px-2 py-2 text-center">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${patient.algorithm_type === 'ABC' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                ${patient.algorithm_type || 'N/A'}
                            </span>
                        </td>
                        <td class="px-2 py-2 font-mono text-xs">${patient.unique_id || 'N/A'}</td>
                        <td class="px-2 py-2">${patient.patient_entry_date || 'N/A'}</td>
                        <td class="px-2 py-2">${patient.patient_name || 'N/A'}</td>
                        <td class="px-2 py-2 text-center">${patient.pat_age || 'N/A'}</td>
                        <td class="px-2 py-2 text-center">${sex}</td>
                        <td class="px-2 py-2">${patient.site_code || 'N/A'}</td>
                        <td class="px-2 py-2">${patient.statename || 'N/A'}</td>
                        <td class="px-2 py-2">${patient.districtname || 'N/A'}</td>
                        <td class="village-column px-2 py-2" ${isGIS ? 'style="display: none;"' : ''}>${patient.villagename || 'N/A'}</td>
                        <td class="px-2 py-2" style="display: none;">${patient.clini_primary_syn || 'N/A'}</td>
                        <td class="px-2 py-2 text-center">
                            <span class="px-2 py-0.5 rounded text-xs font-medium ${correctedAdditionType === 'ORIGINAL' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                                ${correctedAdditionType}
                            </span>
                        </td>
                        <td class="px-2 py-2">${correctedExpansionDate}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('recordCount').textContent = `${filteredPatients.length} patient${filteredPatients.length !== 1 ? 's' : ''}`;
            document.getElementById('pageInfo').textContent = `${startIndex + 1}-${endIndex} of ${filteredPatients.length}`;
            updatePaginationButtons();
        }

        function updatePaginationButtons() {
            const totalPages = Math.ceil(filteredPatients.length / rowsPerPage);
            document.getElementById('firstBtn').disabled = currentPage === 1;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
            document.getElementById('lastBtn').disabled = currentPage >= totalPages;
        }

        // --- Utility Functions ---
        window.goBack = function() {
            window.location.href = 'clusters-view.html';
        }

        window.showMap = function() {
            const clusterId = document.getElementById('clusterSelect').value;
            if (!clusterId) {
                showNotification('Please select a cluster first', 'warning');
                return;
            }
            
            const cluster = allClusters.find(c => c.smart_cluster_id === clusterId);
            if (!cluster || cluster.algorithm_type !== 'GIS') {
                showNotification('Map is only available for GIS clusters', 'warning');
                return;
            }
            
            window.location.href = `cluster-map.html?cluster_id=${clusterId}`;
        }

        window.acceptCluster = async function() {
            const clusterId = document.getElementById('clusterSelect').value;
            if (!clusterId) return;
            
            // Show confirmation modal
            if (!await showConfirmModal('Accept Cluster', `Are you sure you want to accept cluster ${clusterId}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                showNotification('Accepting cluster...', 'primary');
                const response = await fetch(`${SMART_CLUSTER_API}/accept-cluster`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors',
                    body: JSON.stringify({ cluster_id: clusterId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Cluster accepted successfully', 'success');
                    // Reload clusters to get updated data from backend
                    await loadClusters();
                    // Get updated cluster data
                    const updatedCluster = allClusters.find(c => c.smart_cluster_id === clusterId);
                    // Update dropdown options while preserving selection
                    skipOnChange = true;
                    populateClusterDropdown();
                    document.getElementById('clusterSelect').value = clusterId;
                    skipOnChange = false;
                    // Update details panel with fresh data
                    updateClusterDetails(updatedCluster);
                    // Force hide buttons since cluster is now accepted
                    document.getElementById('acceptBtn').classList.add('hidden');
                    document.getElementById('rejectBtn').classList.add('hidden');
                } else {
                    throw new Error(data.error || 'Accept failed');
                }
            } catch (error) {
                showNotification('Error accepting cluster: ' + error.message, 'danger');
            }
        }

        window.rejectCluster = async function() {
            const clusterId = document.getElementById('clusterSelect').value;
            if (!clusterId || !confirm('Reject this cluster? This will delete it permanently.')) return;
            
            try {
                showNotification('Rejecting cluster...', 'primary');
                const response = await fetch(`${SMART_CLUSTER_API}/reject-cluster`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'cors',
                    body: JSON.stringify({ cluster_id: clusterId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Cluster rejected', 'success');
                    window.location.href = 'clusters-view.html';
                } else {
                    throw new Error(data.error || 'Reject failed');
                }
            } catch (error) {
                showNotification('Error rejecting cluster: ' + error.message, 'danger');
            }
        }



        window.showConfirmModal = function(title, message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">${title}</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex space-x-3 justify-end">
                            <button onclick="closeModal(false)" class="px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                            <button onclick="closeModal(true)" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                Accept
                            </button>
                        </div>
                    </div>
                `;
                
                window.closeModal = function(result) {
                    document.body.removeChild(modal);
                    resolve(result);
                };
                
                document.body.appendChild(modal);
            });
        }

        window.showNotification = function(message, type = 'primary') {
            const container = document.getElementById('notificationContainer');
            const colorMap = {
                primary: 'bg-primary border-primary',
                success: 'bg-success border-success',
                warning: 'bg-warning border-warning',
                danger: 'bg-danger border-danger'
            };

            const notif = document.createElement('div');
            notif.className = `p-4 mb-2 rounded-lg text-white shadow-lg border-l-4 ${colorMap[type]}`;
            notif.textContent = message;

            container.appendChild(notif);

            setTimeout(() => {
                notif.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                notif.addEventListener('transitionend', () => container.removeChild(notif));
            }, 3000);
        }
    </script>

    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 max-w-sm">
        <!-- Notifications will appear here -->
    </div>



    <!-- Main Container -->
    <div class="flex flex-col h-screen">
        
        <!-- Header Bar -->
        <div class="bg-white shadow-sm border-b border-gray-200 px-2 py-1 flex items-center justify-between">
            <div class="flex items-center space-x-1.5">
                <button onclick="goBack()" class="flex items-center space-x-0.5 text-gray-600 hover:text-primary transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span class="text-xs font-medium">Back</span>
                </button>
                <div class="h-4 w-px bg-gray-300"></div>
                <h1 class="text-sm font-bold text-gray-800">Sentinel-5</h1>
                <span class="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">Cluster Patient List</span>
            </div>
            <div class="flex items-center space-x-1.5 flex-1 max-w-2xl mx-2">
                <select id="clusterSelect" onchange="onClusterChange()" class="px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-primary focus:border-primary">
                    <option value="">All Clusters</option>
                </select>
                <div class="relative flex-1">
                    <input type="text" id="searchInput" placeholder="Search patient, village, syndrome..." 
                        class="w-full pl-7 pr-2 py-1 border border-gray-300 rounded focus:ring-1 focus:ring-primary focus:border-primary transition text-xs"
                        onkeyup="filterTable()">
                    <svg class="w-3.5 h-3.5 absolute left-2 top-1.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <button onclick="toggleAdvancedFilter()" class="flex items-center space-x-0.5 bg-primary hover:bg-blue-600 text-white px-2 py-1 rounded transition-colors text-xs whitespace-nowrap">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    <span>Filter</span>
                </button>
                <button onclick="refreshData()" class="flex items-center space-x-0.5 bg-success hover:bg-green-600 text-white px-2 py-1 rounded transition-colors text-xs whitespace-nowrap">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>Refresh</span>
                </button>
                <button id="showMapBtn" onclick="showMap()" class="hidden flex items-center space-x-0.5 bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded transition-colors text-xs whitespace-nowrap">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>
                    </svg>
                    <span>Show Map</span>
                </button>
                <button id="acceptBtn" onclick="acceptCluster()" class="hidden flex items-center space-x-0.5 bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded transition-colors text-xs whitespace-nowrap">
                    <span>✓ Accept</span>
                </button>
                <button id="rejectBtn" onclick="rejectCluster()" class="hidden flex items-center space-x-0.5 bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-colors text-xs whitespace-nowrap">
                    <span>✗ Reject</span>
                </button>
            </div>
            <div class="flex items-center">
                <span id="recordCount" class="text-xs text-gray-600 bg-primary/10 px-2 py-0.5 rounded font-medium">0 patients</span>
            </div>
        </div>

        <!-- Cluster Details Panel -->
        <div id="clusterDetailsPanel" class="hidden bg-blue-50 border-b border-blue-200 px-3 py-2">
            <div class="grid grid-cols-6 gap-4 text-xs">
                <div>
                    <span class="font-medium text-gray-600">Cluster ID:</span>
                    <div id="detailClusterId" class="font-mono text-blue-700">-</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Algorithm:</span>
                    <div id="detailAlgorithm" class="font-medium">-</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Status:</span>
                    <div id="detailStatus" class="font-medium">-</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Patients:</span>
                    <div id="detailPatientCount" class="font-medium text-green-700">-</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Date Range:</span>
                    <div id="detailDateRange" class="text-gray-700">-</div>
                </div>
                <div>
                    <span class="font-medium text-gray-600">Syndrome:</span>
                    <div id="detailSyndrome" class="text-gray-700">-</div>
                </div>
            </div>
        </div>

        <!-- Advanced Filter Panel -->
        <div id="advancedFilterPanel" class="hidden bg-gray-50 border-b border-gray-200 px-3 py-2">
            <div class="grid grid-cols-4 gap-2">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-0.5">Addition Type</label>
                    <select id="filterAdditionType" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-primary focus:border-primary transition" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="ORIGINAL">Original</option>
                        <option value="EXPANSION">Expansion</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-0.5">Sex</label>
                    <select id="filterSex" class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-primary focus:border-primary transition" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="1">Male</option>
                        <option value="2">Female</option>
                        <option value="3">Other</option>
                    </select>
                </div>
                <div class="col-span-2 flex items-end">
                    <button onclick="clearFilters()" class="w-full px-2 py-1 text-xs text-gray-600 hover:text-primary hover:bg-gray-100 border border-gray-300 rounded transition-colors">Clear Filters</button>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div class="flex-1 overflow-hidden p-1.5">
            <div class="bg-white rounded-lg shadow h-full flex flex-col overflow-hidden">
                <div class="flex-1 overflow-auto custom-scroll">
                    <table class="w-full compact-table text-left">
                        <thead>
                            <tr class="border-b border-gray-200">
                                <th class="text-xs font-semibold text-gray-600">Cluster ID</th>
                                <th class="text-xs font-semibold text-gray-600 text-center">Algorithm</th>
                                <th class="text-xs font-semibold text-gray-600">Patient ID</th>
                                <th class="text-xs font-semibold text-gray-600">Entry Date</th>
                                <th class="text-xs font-semibold text-gray-600">Name</th>
                                <th class="text-xs font-semibold text-gray-600 text-center">Age</th>
                                <th class="text-xs font-semibold text-gray-600 text-center">Sex</th>
                                <th class="text-xs font-semibold text-gray-600">Site Code</th>
                                <th class="text-xs font-semibold text-gray-600">State</th>
                                <th class="text-xs font-semibold text-gray-600">District</th>
                                <th id="villageHeader" class="text-xs font-semibold text-gray-600">Village</th>
                                <th class="text-xs font-semibold text-gray-600" style="display: none;">Syndrome</th>
                                <th class="text-xs font-semibold text-gray-600 text-center">Addition Type</th>
                                <th class="text-xs font-semibold text-gray-600">Expansion Date</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr><td colspan="14" class="text-center py-6 text-gray-400 text-xs">Select a cluster or load all patients...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="border-t border-gray-200 px-3 py-1.5 flex items-center justify-between bg-gray-50">
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-600">Rows:</span>
                        <select id="rowsPerPage" class="px-1.5 py-0.5 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-primary focus:border-primary" onchange="changeRowsPerPage()">
                            <option value="10">10</option>
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span id="pageInfo" class="text-xs text-gray-600">0-0 of 0</span>
                        <div class="flex items-center space-x-0.5">
                            <button onclick="firstPage()" class="px-1.5 py-0.5 border border-gray-300 rounded hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="firstBtn">
                                <svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <button onclick="prevPage()" class="px-1.5 py-0.5 border border-gray-300 rounded hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="prevBtn">
                                <svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </button>
                            <button onclick="nextPage()" class="px-1.5 py-0.5 border border-gray-300 rounded hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="nextBtn">
                                <svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </button>
                            <button onclick="lastPage()" class="px-1.5 py-0.5 border border-gray-300 rounded hover:bg-gray-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" id="lastBtn">
                                <svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Management System</title>
    <link rel="stylesheet" href="dist/output.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        #sidebar {
            transition: width 0.3s ease, padding 0.3s ease;
        }
        #sidebar.collapsed {
            width: 3rem;
        }
        #sidebar.collapsed .nav-text,
        #sidebar.collapsed h2,
        #sidebar.collapsed #userIdDisplay {
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: opacity 0.2s ease;
        }
        #sidebar:not(.collapsed) .nav-text,
        #sidebar:not(.collapsed) h2,
        #sidebar:not(.collapsed) #userIdDisplay {
            opacity: 1;
            width: auto;
            transition: opacity 0.3s ease 0.1s;
        }
        #sidebar.collapsed .nav-item {
            justify-content: center;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        #sidebar.collapsed .nav-item svg {
            margin: 0;
        }
        #sidebar.collapsed .px-5 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        #sidebar.collapsed .border-b,
        #sidebar.collapsed .border-t {
            border-left: 0;
            border-right: 0;
        }
    </style>

</head>
<body class="bg-background font-sans antialiased text-gray-800">

    <!-- Firebase Auth -->
    <script type="module" src="auth.js"></script>

    <script>
        const DASHBOARD_API = 'https://dashboard-api-196547645490.asia-south1.run.app';

        // Initialize application
        window.onload = function() {
            console.log('Application loaded');
            loadDashboard();
            loadConfiguration(); // Load saved settings
        };
        
        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        async function loadDashboard() {
            try {
                // Load system overview stats from dashboard API
                const statsResponse = await fetch(`${DASHBOARD_API}/api/smart-clusters/stats`);
                const statsData = await statsResponse.json();
                
                if (statsData.success) {
                    const stats = statsData.data;
                    
                    // Update dashboard statistics with correct metrics
                    document.getElementById('dash-total-records').textContent = stats.total_records?.toLocaleString() || '0';
                    document.getElementById('dash-total-clusters').textContent = stats.total_clusters?.toLocaleString() || '0';
                    document.getElementById('dash-last-updated').textContent = stats.last_uploaded_date || 'N/A';
                    document.getElementById('dash-last-analysed').textContent = stats.last_analysed_date || 'N/A';
                    document.getElementById('dash-pending').textContent = stats.total_pending?.toLocaleString() || '0';
                    
                    console.log('Dashboard stats loaded:', stats);
                } else {
                    console.error('Failed to load stats:', statsData.error);
                }
                
                // Load geocoding status and health checks
                await loadSystemHealth();
                
                // Load tuning parameters
                loadTuningParameters();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Failed to load dashboard data', 'danger');
            }
        }

        async function loadSystemHealth() {
            // Check geocoding status
            try {
                const geocodingResponse = await fetch(`${DASHBOARD_API}/api/geocoding/progress`);
                const geocodingData = await geocodingResponse.json();
                
                if (geocodingData.success) {
                    const pct = geocodingData.data.completion_pct || 0;
                    document.getElementById('geocoding-status').innerHTML = `<span class="${pct >= 85 ? 'text-green-600' : 'text-orange-500'}">${pct.toFixed(1)}% Complete</span>`;
                } else {
                    document.getElementById('geocoding-status').innerHTML = '<span class="text-red-500">Error</span>';
                }
            } catch (error) {
                document.getElementById('geocoding-status').innerHTML = '<span class="text-red-500">Error</span>';
            }

            // Health check functions with proper CORS handling
            const services = [
                { id: 'upload-health', name: 'Upload Function' },
                { id: 'bigquery-health', name: 'BigQuery Sync' },
                { id: 'geocoding-health', name: 'Geocoding Service' },
                { id: 'dashboard-health', name: 'Dashboard API' }
            ];

            // Check all services through dashboard API
            try {
                const healthResponse = await fetch(`${DASHBOARD_API}/api/health/services`);
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    services.forEach(service => {
                        const status = healthData[service.name] || 'unknown';
                        const isHealthy = status === 'healthy';
                        document.getElementById(service.id).innerHTML = `<span class="${isHealthy ? 'text-green-600' : 'text-red-500'}">${isHealthy ? '✓ Healthy' : '✗ Down'}</span>`;
                    });
                } else {
                    services.forEach(service => {
                        document.getElementById(service.id).innerHTML = '<span class="text-red-500">✗ Unknown</span>';
                    });
                }
            } catch (error) {
                services.forEach(service => {
                    document.getElementById(service.id).innerHTML = '<span class="text-red-500">✗ Error</span>';
                });
            }
        }


        // SETTINGS OPERATIONS
        // Removed global settingsDocPath definition

        window.loadSettings = async function() {
            if (!db || !userId) return;
            try {
                // FIX: Dynamically construct the doc reference using path segments
                const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config');
                const settingsSnap = await getDoc(settingsDocRef);
                
                if (settingsSnap.exists()) {
                    const settings = settingsSnap.data();
                    document.getElementById('autoSave').checked = settings.autoSave ?? true;
                    document.getElementById('notifications').checked = settings.notifications ?? false;
                    document.getElementById('maxRecords').value = settings.maxRecords ?? 100;
                    // Only show notification if it successfully loaded data
                    // showNotification('Settings loaded.', 'success'); 
                }
            } catch (e) {
                console.error("Error loading settings:", e);
                // Notification for user is handled by onAuthStateChanged error boundary
            }
        }

        window.saveSettings = async function() {
            if (!db || !userId) return;
            // FIX: Dynamically construct the doc reference using path segments
            const settingsDocRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'config');
            try {
                const settings = {
                    autoSave: document.getElementById('autoSave').checked,
                    notifications: document.getElementById('notifications').checked,
                    maxRecords: parseInt(document.getElementById('maxRecords').value, 10) || 100,
                    updatedAt: serverTimestamp()
                };
                await setDoc(settingsDocRef, settings, { merge: true });
                showNotification('Settings saved successfully!', 'success');
            } catch (e) {
                console.error("Error saving settings:", e);
                showNotification('Error saving settings.', 'danger');
            }
        }
        
        window.clearData = function() {
            showConfirmationModal(
                'Clear All Data',
                'Are you absolutely sure you want to clear ALL Clusters and Merge Items? This action cannot be undone.',
                async () => {
                    if (!db || !userId) return;
                    try {
                        const batch = writeBatch(db);
                        
                        // Delete all clusters
                        const clustersQuery = query(collection(db, `artifacts/${appId}/users/${userId}/clusters`));
                        const clusterSnapshot = await getDocs(clustersQuery);
                        clusterSnapshot.docs.forEach(d => batch.delete(d.ref));

                        // Delete all merge items
                        const mergeQuery = query(collection(db, `artifacts/${appId}/users/${userId}/merge_items`));
                        const mergeSnapshot = await getDocs(mergeQuery);
                        mergeSnapshot.docs.forEach(d => batch.delete(d.ref));

                        await batch.commit();
                        showNotification('All application data cleared successfully.', 'success');
                    } catch (e) {
                        console.error("Error clearing data:", e);
                        showNotification('Error clearing data.', 'danger');
                    }
                }
            );
        }

        // --- UI Rendering Functions ---
        
        function updateStats() {
            const totalClusters = window.globalClusters?.length || 0;
            const totalUrban = window.globalUrban?.length || 0;
            const totalRural = window.globalRural?.length || 0;
            const totalRecords = (window.globalClusters?.reduce((sum, c) => sum + c.items.length, 0) || 0) + totalUrban + totalRural;

            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('totalClusters').textContent = totalClusters;
            document.getElementById('totalMerges').textContent = totalUrban + totalRural;
        }

        function updateClusterList(clusters) {
            const list = document.getElementById('clusterList');
            if (clusters.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-gray-400">No clusters created yet</td></tr>';
                return;
            }

            // Sort by creation time (newest first, assuming timestamp is present)
            clusters.sort((a, b) => (b.created?.seconds || 0) - (a.created?.seconds || 0));
            
            list.innerHTML = clusters.map(cluster => {
                const statusColor = cluster.status === 'accepted' ? 'text-success' : 'text-danger';
                const statusIcon = cluster.status === 'accepted' ? '✓' : '✗';
                const createdTime = cluster.created ? new Date(cluster.created.seconds * 1000).toLocaleString() : 'N/A';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-blue-50 transition-colors">
                        <td class="p-3 text-gray-500">${cluster.id.substring(0, 8)}...</td>
                        <td class="p-3 font-medium">${cluster.items.join(', ')}</td>
                        <td class="p-3 text-sm text-gray-500">${createdTime}</td>
                        <td class="p-3 text-center">
                            <span class="${statusColor} font-bold text-lg cursor-pointer" 
                                onclick="toggleClusterStatus('${cluster.id}', '${cluster.status}')" 
                                title="Click to toggle status">
                                ${statusIcon}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="deleteCluster('${cluster.id}')" class="bg-danger hover:bg-red-600 text-white px-3 py-1 text-xs rounded-lg shadow-md transition-colors">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }



        // --- General UI Utilities ---
        
        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        window.switchSection = function(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-primary/10', 'border-primary', 'font-semibold');
            });
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('flex');
                sec.classList.add('hidden');
            });
            
            document.querySelector(`[data-section="${section}"]`).classList.add('bg-primary/10', 'border-primary', 'font-semibold');
            document.getElementById(section).classList.remove('hidden');
            document.getElementById(section).classList.add('flex');
        }

        // Initialize first section view
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    window.switchSection(this.dataset.section);
                });
            });
            window.switchSection('dashboard');
        });

        // --- Modal/Notification System (Replacement for alert/confirm) ---

        // Confirmation Modal
        let confirmCallback = () => {};

        window.showConfirmationModal = function(title, message, callback) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmationModal').classList.remove('hidden');
        }

        window.confirmAction = function() {
            confirmCallback();
            document.getElementById('confirmationModal').classList.add('hidden');
        }

        window.cancelAction = function() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }

        // Edit Configuration Warning
        window.showEditWarning = function() {
            document.getElementById('editWarningModal').classList.remove('hidden');
        }

        window.confirmEditWarning = function() {
            document.getElementById('editWarningModal').classList.add('hidden');
            // Enable all config inputs
            document.querySelectorAll('.config-input').forEach(input => {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
                input.classList.add('focus:ring-1', 'focus:ring-primary', 'focus:border-primary');
            });
            // Enable save button
            const saveBtn = document.getElementById('saveConfigBtn');
            saveBtn.disabled = false;
            saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            // Hide edit button
            document.getElementById('editConfigBtn').classList.add('hidden');
        }

        window.cancelEditWarning = function() {
            document.getElementById('editWarningModal').classList.add('hidden');
        }
        
        // Add Cluster/Merge Modals
        window.showAddClusterModal = function() {
            document.getElementById('addClusterModal').classList.remove('hidden');
        }

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Notification System
        window.showNotification = function(message, type = 'primary') {
            const container = document.getElementById('notificationContainer');
            const colorMap = {
                primary: 'bg-primary border-primary',
                success: 'bg-success border-success',
                warning: 'bg-warning border-warning',
                danger: 'bg-danger border-danger'
            };

            const notif = document.createElement('div');
            notif.className = `p-4 mb-2 rounded-lg text-white shadow-lg border-l-4 ${colorMap[type]}`;
            notif.textContent = message;

            container.appendChild(notif);

            setTimeout(() => {
                notif.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                notif.addEventListener('transitionend', () => container.removeChild(notif));
            }, 3000);
        }

        // Load settings from localStorage on page load
        window.loadConfiguration = function() {
            const savedConfig = localStorage.getItem('clusterConfig');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('dbscan_epsilon').value = config.dbscan_epsilon_m || 500;
                document.getElementById('max_cluster_radius').value = config.max_cluster_radius || 800;
                document.getElementById('min_cluster_size').value = config.min_cluster_size || 2;
                document.getElementById('time_window_days').value = config.time_window_days || 6;
                document.getElementById('max_cluster_age').value = config.max_cluster_age_days || 7;
                document.getElementById('geocoding_threshold').value = config.geocoding_threshold || 0.85;
                document.getElementById('auto_accept_radius').value = config.auto_accept_radius_threshold || 200;
            }
        }

        window.saveConfiguration = function() {
            const config = {
                dbscan_epsilon_m: parseInt(document.getElementById('dbscan_epsilon').value),
                max_cluster_radius: parseInt(document.getElementById('max_cluster_radius').value),
                min_cluster_size: parseInt(document.getElementById('min_cluster_size').value),
                time_window_days: parseInt(document.getElementById('time_window_days').value),
                max_cluster_age_days: parseInt(document.getElementById('max_cluster_age').value),
                geocoding_threshold: parseFloat(document.getElementById('geocoding_threshold').value),
                auto_accept_radius_threshold: parseInt(document.getElementById('auto_accept_radius').value),
                updated_at: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('clusterConfig', JSON.stringify(config));
            
            showNotification('Configuration saved successfully!', 'success');
            
            // Disable inputs again after save
            document.querySelectorAll('.config-input').forEach(input => {
                input.disabled = true;
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
            });
            document.getElementById('saveConfigBtn').disabled = true;
            document.getElementById('saveConfigBtn').classList.add('opacity-50', 'cursor-not-allowed');
            document.getElementById('editConfigBtn').classList.remove('hidden');
        }

        // Get current configuration for API calls
        window.getConfiguration = function() {
            const savedConfig = localStorage.getItem('clusterConfig');
            return savedConfig ? JSON.parse(savedConfig) : {
                dbscan_epsilon_m: 500,
                max_cluster_radius: 800,
                min_cluster_size: 2,
                time_window_days: 6,
                max_cluster_age_days: 7,
                geocoding_threshold: 0.85,
                auto_accept_radius_threshold: 200
            };
        }

        // Load tuning parameters in dashboard
        window.loadTuningParameters = function() {
            const config = getConfiguration();
            document.getElementById('param-dbscan').textContent = config.dbscan_epsilon_m + 'm';
            document.getElementById('param-radius').textContent = config.max_cluster_radius + 'm';
            document.getElementById('param-size').textContent = config.min_cluster_size;
            document.getElementById('param-time').textContent = config.time_window_days + ' days';
            document.getElementById('param-age').textContent = config.max_cluster_age_days + ' days';
            document.getElementById('param-geocoding').textContent = (config.geocoding_threshold * 100) + '%';
            document.getElementById('param-accept').textContent = config.auto_accept_radius_threshold + 'm';
        }
    </script>

    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50 max-w-sm">
        <!-- Notifications will appear here -->
    </div>

    <!-- Main Application Container -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="h-screen">
            <div id="sidebar" class="sidebar w-48 bg-white shadow-lg my-2 ml-2 mr-0 rounded-lg flex flex-col transition-all duration-300 custom-scroll overflow-y-auto h-[calc(100vh-1rem)]">
                
                <div class="px-3 pt-3 pb-2 flex justify-between items-center border-b border-gray-200">
                    <h2 class="text-base font-bold text-gray-800 whitespace-nowrap">Sentinel-5</h2>
                    <button class="text-gray-500 hover:text-gray-900 focus:outline-none flex-shrink-0" onclick="toggleSidebar()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
                
                <div class="py-1 flex-grow">
                    <div class="nav-item p-2 mx-2 my-0.5 rounded cursor-pointer transition-colors hover:bg-gray-100 border-l-2 border-transparent active-item bg-primary/10 border-primary font-semibold flex items-center" data-section="dashboard">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <span class="nav-text ml-2 text-sm">Dashboard</span>
                    </div>
                    <div class="nav-item p-2 mx-2 my-0.5 rounded cursor-pointer transition-colors hover:bg-gray-100 border-l-2 border-transparent flex items-center" onclick="window.location.href='data-import.html'">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span class="nav-text ml-2 text-sm">Import & Export</span>
                    </div>
                    <div class="nav-item p-2 mx-2 my-0.5 rounded cursor-pointer transition-colors hover:bg-gray-100 border-l-2 border-transparent flex items-center" onclick="window.location.href='clusters-view.html'">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        <span class="nav-text ml-2 text-sm">Clusters</span>
                    </div>
                    <div class="nav-item p-2 mx-2 my-0.5 rounded cursor-pointer transition-colors hover:bg-gray-100 border-l-2 border-transparent flex items-center" onclick="window.location.href='cluster-engine.html'">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 3-3m-6 6l3 3 3-3"></path></svg>
                        <span class="nav-text ml-2 text-sm">Cluster Engine</span>
                    </div>
                    <div class="nav-item p-2 mx-2 my-0.5 rounded cursor-pointer transition-colors hover:bg-gray-100 border-l-2 border-transparent flex items-center" data-section="settings">
                        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="nav-text ml-2 text-sm">Settings</span>
                    </div>
                </div>
                
                <div class="px-3 py-2 border-t border-gray-200">
                    <p id="userIdDisplay" class="text-xs text-gray-500 truncate">Loading...</p>
                    <button onclick="logout()" class="mt-1 text-xs text-danger hover:underline">Logout</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content flex-1 overflow-hidden">
            
            <!-- Dashboard Section -->
            <div class="section h-full flex flex-col" id="dashboard">
                <!-- Compact Header -->
                <div class="bg-white border-b border-gray-200 px-3 py-2">
                    <h1 class="text-lg font-bold text-gray-800">Dashboard</h1>
                </div>

                <!-- 3 Container Layout -->
                <div class="flex-1 p-2 grid grid-cols-3 gap-2">
                    <!-- Container 1: System Overview -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-3 overflow-auto custom-scroll">
                        <h2 class="text-sm font-bold text-gray-800 mb-3 pb-2 border-b flex items-center">
                            <svg class="w-4 h-4 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                            System Overview
                        </h2>
                        
                        <!-- Statistics Table -->
                        <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-lg p-3 mb-3">
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Total Records</td>
                                        <td class="py-2 text-right font-bold text-blue-600" id="dash-total-records">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Total Clusters</td>
                                        <td class="py-2 text-right font-bold text-green-600" id="dash-total-clusters">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Last Updated Date</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="dash-last-updated">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Last Analysed Date</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="dash-last-analysed">-</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 font-medium">Current Pending</td>
                                        <td class="py-2 text-right font-bold text-warning cursor-pointer hover:text-orange-600 hover:underline" id="dash-pending" onclick="window.location.href='clusters-view.html?filter=pending'">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Quick Actions -->
                        <div class="space-y-2">
                            <p class="text-xs text-gray-600 font-semibold mb-2">Quick Actions</p>
                            
                            <button onclick="window.location.href='cluster-engine.html'" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all shadow hover:shadow-md flex items-center justify-center">
                                <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                Run Cluster Engine
                            </button>
                            
                            <button onclick="window.location.href='data-import.html'" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all shadow hover:shadow-md flex items-center justify-center">
                                <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                Import & Export
                            </button>
                            
                            <button onclick="window.location.href='clusters-view.html'" class="w-full bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-3 py-2 rounded-lg text-xs font-medium transition-all shadow hover:shadow-md flex items-center justify-center">
                                <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                View All Clusters
                            </button>
                        </div>
                    </div>

                    <!-- Container 2: System Health -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-3 overflow-auto custom-scroll">
                        <h2 class="text-sm font-bold text-gray-800 mb-3 pb-2 border-b flex items-center">
                            <svg class="w-4 h-4 mr-2 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            System Health
                        </h2>
                        
                        <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-lg p-3">
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Geocoding Status</td>
                                        <td class="py-2 text-right font-semibold" id="geocoding-status">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Upload Function</td>
                                        <td class="py-2 text-right font-semibold" id="upload-health">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">BigQuery Sync</td>
                                        <td class="py-2 text-right font-semibold" id="bigquery-health">-</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Geocoding Service</td>
                                        <td class="py-2 text-right font-semibold" id="geocoding-health">-</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 font-medium">Dashboard API</td>
                                        <td class="py-2 text-right font-semibold" id="dashboard-health">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Container 3: Tuning Parameters -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-3 overflow-auto custom-scroll">
                        <h2 class="text-sm font-bold text-gray-800 mb-3 pb-2 border-b flex items-center">
                            <svg class="w-4 h-4 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path></svg>
                            Tuning Parameters
                        </h2>
                        
                        <div class="bg-gradient-to-br from-slate-50 to-gray-50 rounded-lg p-3">
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">DBSCAN Epsilon</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-dbscan">500m</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Max Cluster Radius</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-radius">800m</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Min Cluster Size</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-size">2</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Time Window</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-time">6 days</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Max Cluster Age</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-age">7 days</td>
                                    </tr>
                                    <tr class="border-b border-gray-200">
                                        <td class="py-2 text-gray-600 font-medium">Geocoding Threshold</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-geocoding">85%</td>
                                    </tr>
                                    <tr>
                                        <td class="py-2 text-gray-600 font-medium">Auto Accept Radius</td>
                                        <td class="py-2 text-right font-semibold text-gray-700" id="param-accept">200m</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                const API_ENDPOINT = 'https://sentinel-upload-service-196547645490.asia-south1.run.app';
                const referenceSchema = [{"column_name":"patient_id","data_type":"INT64"},{"column_name":"site_code","data_type":"STRING"},{"column_name":"hospital_reg_id","data_type":"STRING"},{"column_name":"patient_entry_date","data_type":"DATE"},{"column_name":"pat_admi_location","data_type":"INT64"},{"column_name":"patient_name","data_type":"STRING"},{"column_name":"pat_mid_name","data_type":"STRING"},{"column_name":"pat_sodo","data_type":"STRING"},{"column_name":"pat_age","data_type":"INT64"},{"column_name":"pat_agemonths","data_type":"STRING"},{"column_name":"pat_agedays","data_type":"INT64"},{"column_name":"pat_sex","data_type":"INT64"},{"column_name":"pat_contact_his","data_type":"INT64"},{"column_name":"pat_health_worker","data_type":"INT64"},{"column_name":"pat_hw_contact","data_type":"INT64"},{"column_name":"pat_travel_his","data_type":"INT64"},{"column_name":"pat_travel_type","data_type":"INT64"},{"column_name":"pat_travel_int","data_type":"STRING"},{"column_name":"pat_travel_dom","data_type":"INT64"},{"column_name":"pat_country","data_type":"STRING"},{"column_name":"statename","data_type":"STRING"},{"column_name":"districtname","data_type":"STRING"},{"column_name":"subdistrictname","data_type":"STRING"},{"column_name":"villagename","data_type":"STRING"},{"column_name":"latitude","data_type":"FLOAT64"},{"column_name":"longitude","data_type":"FLOAT64"},{"column_name":"pat_street","data_type":"STRING"},{"column_name":"pat_house","data_type":"STRING"},{"column_name":"pat_pincode","data_type":"INT64"},{"column_name":"pat_areatype","data_type":"STRING"},{"column_name":"pat_occupation","data_type":"INT64"},{"column_name":"pat_occupation_others","data_type":"STRING"},{"column_name":"clini_date_illness","data_type":"STRING"},{"column_name":"clini_dura_days","data_type":"INT64"},{"column_name":"clini_primary_syn","data_type":"STRING"},{"column_name":"syndrome_other_p","data_type":"STRING"},{"column_name":"sym_fever","data_type":"BOOL"},{"column_name":"sym_new_onset_of_seizures","data_type":"BOOL"},{"column_name":"sym_dysentery","data_type":"BOOL"},{"column_name":"sym_jaundice","data_type":"BOOL"},{"column_name":"sym_papule_rash","data_type":"BOOL"},{"column_name":"sym_vomiting","data_type":"BOOL"},{"column_name":"sym_myalgia","data_type":"BOOL"},{"column_name":"sym_breathlessness","data_type":"BOOL"},{"column_name":"sym_sore_throat","data_type":"BOOL"},{"column_name":"sym_cough","data_type":"BOOL"},{"column_name":"sym_yellow_urine","data_type":"BOOL"},{"column_name":"sym_yellow_skin","data_type":"BOOL"},{"column_name":"sym_eschar","data_type":"STRING"},{"column_name":"sym_altered_sensorium","data_type":"BOOL"},{"column_name":"sym_increased_somnolence","data_type":"BOOL"},{"column_name":"sym_dark_urine","data_type":"BOOL"},{"column_name":"sym_yellow_sclera","data_type":"BOOL"},{"column_name":"sym_nausea","data_type":"BOOL"},{"column_name":"sym_irritability","data_type":"BOOL"},{"column_name":"sym_diarrhea","data_type":"BOOL"},{"column_name":"sym_neck_rigidity","data_type":"BOOL"},{"column_name":"sym_headache","data_type":"BOOL"},{"column_name":"sym_chills","data_type":"BOOL"},{"column_name":"sym_malaise","data_type":"BOOL"},{"column_name":"sym_discharge_eyes","data_type":"STRING"},{"column_name":"sym_arthralgia","data_type":"BOOL"},{"column_name":"sym_abdominal_pain","data_type":"BOOL"},{"column_name":"sym_redness_eyes","data_type":"BOOL"},{"column_name":"sym_retro_orb_pain","data_type":"BOOL"},{"column_name":"sym_other_symptom","data_type":"BOOL"},{"column_name":"symptom_other","data_type":"STRING"},{"column_name":"vit_pulse","data_type":"INT64"},{"column_name":"vit_bp_sys","data_type":"INT64"},{"column_name":"vit_bp_dia","data_type":"INT64"},{"column_name":"vit_temp","data_type":"INT64"},{"column_name":"vit_resp_rate","data_type":"INT64"},{"column_name":"vit_spo2","data_type":"INT64"},{"column_name":"vit_dehyd","data_type":"INT64"},{"column_name":"vit_icterus","data_type":"INT64"},{"column_name":"vit_edema","data_type":"INT64"},{"column_name":"vit_conj","data_type":"INT64"},{"column_name":"vit_conj_sub","data_type":"INT64"},{"column_name":"vit_eschar","data_type":"INT64"},{"column_name":"vit_eschar_value","data_type":"INT64"},{"column_name":"vit_cbc_done","data_type":"INT64"},{"column_name":"vit_cbc_hemat","data_type":"FLOAT64"},{"column_name":"vit_cbc_hb","data_type":"FLOAT64"},{"column_name":"vit_cbc_rbc","data_type":"FLOAT64"},{"column_name":"vit_cbc_wbc","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_n","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_l","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_m","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_e","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_b","data_type":"FLOAT64"},{"column_name":"vit_cbc_esr","data_type":"FLOAT64"},{"column_name":"vit_cbc_plat","data_type":"INT64"},{"column_name":"vit_lf_done","data_type":"INT64"},{"column_name":"vit_lf_al","data_type":"FLOAT64"},{"column_name":"vit_lf_pro","data_type":"FLOAT64"},{"column_name":"vit_lf_ast","data_type":"FLOAT64"},{"column_name":"vit_lf_alt","data_type":"FLOAT64"},{"column_name":"vit_lf_ggt","data_type":"INT64"},{"column_name":"vit_lf_bil_d","data_type":"FLOAT64"},{"column_name":"vit_lf_bil_i","data_type":"FLOAT64"},{"column_name":"vit_lf_bil_t","data_type":"FLOAT64"},{"column_name":"vit_rf_done","data_type":"INT64"},{"column_name":"vit_rf_urea","data_type":"FLOAT64"},{"column_name":"vit_rf_creat","data_type":"FLOAT64"},{"column_name":"vit_rf_chl","data_type":"FLOAT64"},{"column_name":"vit_rf_sod","data_type":"FLOAT64"},{"column_name":"vit_rf_pot","data_type":"FLOAT64"},{"column_name":"vit_rf_uric","data_type":"FLOAT64"},{"column_name":"vit_rf_cal","data_type":"FLOAT64"},{"column_name":"vit_rf_urea_r","data_type":"INT64"},{"column_name":"vit_apr_done","data_type":"INT64"},{"column_name":"vit_apr_crp","data_type":"FLOAT64"},{"column_name":"vit_apr_ldh","data_type":"FLOAT64"},{"column_name":"vit_apr_ddimer","data_type":"FLOAT64"},{"column_name":"vit_apr_ferr","data_type":"FLOAT64"},{"column_name":"vit_apr_tferr","data_type":"FLOAT64"},{"column_name":"vit_apr_proca","data_type":"FLOAT64"},{"column_name":"vit_diag","data_type":"STRING"},{"column_name":"vit_comorbid","data_type":"INT64"},{"column_name":"vit_comorbid_others","data_type":"STRING"},{"column_name":"vit_icu_shift","data_type":"INT64"},{"column_name":"vit_icu_duration","data_type":"INT64"},{"column_name":"vit_outcome","data_type":"INT64"},{"column_name":"vit_death_cause","data_type":"STRING"},{"column_name":"vit_discharge_date","data_type":"STRING"}];
                
                let selectedFile = null;

                function handleFileSelect(event) {
                    selectedFile = event.target.files[0];
                    if (selectedFile) {
                        document.getElementById('fileName').textContent = selectedFile.name;
                        document.getElementById('fileSize').textContent = (selectedFile.size / 1024).toFixed(2) + ' KB';
                        document.getElementById('fileInfo').classList.remove('hidden');
                        document.getElementById('uploadBtn').disabled = false;
                    }
                }

                async function uploadCSV() {
                    if (!selectedFile) return;
                    
                    const uploadBtn = document.getElementById('uploadBtn');
                    const uploadStatus = document.getElementById('uploadStatus');
                    
                    uploadBtn.disabled = true;
                    uploadStatus.textContent = 'Validating CSV...';
                    uploadStatus.className = 'mt-2 text-xs text-primary';
                    uploadStatus.classList.remove('hidden');
                    
                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        try {
                            const csvData = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
                            const headers = csvData.meta.fields;
                            const rows = csvData.data;
                            const requiredColumns = referenceSchema.map(col => col.column_name);
                            
                            let errors = [];
                            
                            // Validate columns
                            headers.forEach(header => {
                                if (!requiredColumns.includes(header)) {
                                    errors.push(`Unknown column: ${header}`);
                                }
                            });
                            
                            requiredColumns.forEach(required => {
                                if (!headers.includes(required)) {
                                    errors.push(`Missing column: ${required}`);
                                }
                            });
                            
                            if (errors.length) {
                                uploadStatus.innerHTML = `<strong>Validation Errors:</strong><br>${errors.join('<br>')}`;
                                uploadStatus.className = 'mt-2 text-xs text-danger';
                                uploadBtn.disabled = false;
                                return;
                            }
                            
                            // Process rows
                            const processedRows = rows.map(row => {
                                row.latitude = '';
                                row.longitude = '';
                                
                                const addressParts = [
                                    row.pat_house || '',
                                    row.pat_street || '',
                                    row.villagename || '',
                                    row.subdistrictname || '',
                                    row.districtname || '',
                                    row.statename || '',
                                    row.pat_pincode || ''
                                ].filter(part => part.trim()).join(' | ');
                                
                                row.complete_address_column = addressParts;
                                row.unique_id = `${row.patient_id || ''}_${row.site_code || ''}_${row.patient_entry_date || ''}`;
                                
                                return row;
                            });
                            
                            // Deduplication
                            const seenIds = new Set();
                            const deduplicatedRows = processedRows.filter(row => {
                                if (seenIds.has(row.unique_id)) {
                                    return false;
                                }
                                seenIds.add(row.unique_id);
                                return true;
                            });
                            
                            const duplicateCount = processedRows.length - deduplicatedRows.length;
                            
                            uploadStatus.textContent = `Validated! Uploading ${deduplicatedRows.length} rows (${duplicateCount} duplicates removed)...`;
                            
                            // Upload
                            const modifiedCSV = Papa.unparse(deduplicatedRows);
                            const formData = new FormData();
                            formData.append('file', new File([modifiedCSV], `validated_${selectedFile.name}`, { type: 'text/csv' }));
                            
                            const response = await fetch(`${API_ENDPOINT}/upload`, {
                                method: 'POST',
                                body: formData
                            });
                            
                            const result = await response.json();
                            
                            if (response.ok) {
                                uploadStatus.innerHTML = `<strong>✓ Upload successful!</strong><br>File: ${result.fileName}<br>Rows: ${deduplicatedRows.length} (${duplicateCount} duplicates removed)`;
                                uploadStatus.className = 'mt-2 text-xs text-success';
                                
                                // Reset form
                                setTimeout(() => {
                                    selectedFile = null;
                                    document.getElementById('csvFileInput').value = '';
                                    document.getElementById('fileInfo').classList.add('hidden');
                                    uploadBtn.disabled = true;
                                    uploadStatus.classList.add('hidden');
                                }, 5000);
                            } else {
                                throw new Error(result.error || 'Upload failed');
                            }
                        } catch (error) {
                            uploadStatus.textContent = 'Error: ' + error.message;
                            uploadStatus.className = 'mt-2 text-xs text-danger';
                            uploadBtn.disabled = false;
                        }
                    };
                    
                    reader.readAsText(selectedFile);
                }
            </script>





            <!-- Export Reports Section -->
            <div class="section hidden flex-col h-full" id="reports">
                <div class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">Export Reports</h1>
                        <p class="text-sm text-gray-500">Coming soon...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="section hidden flex-col h-full" id="settings">
                <!-- Compact Header -->
                <div class="bg-white border-b border-gray-200 px-3 py-2">
                    <h1 class="text-lg font-bold text-gray-800">Settings</h1>
                </div>

                <!-- 3 Container Layout -->
                <div class="flex-1 p-2 grid grid-cols-3 gap-2">
                    <!-- Container 1: Configuration Parameters -->
                    <div class="bg-white rounded-lg shadow border border-gray-200 p-3 overflow-auto custom-scroll">
                        <h2 class="text-sm font-bold text-gray-800 mb-2 pb-2 border-b flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                Configuration Parameters
                            </div>
                            <button id="editConfigBtn" onclick="showEditWarning()" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs font-medium transition-colors flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Edit
                            </button>
                        </h2>
                        <div class="space-y-2">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">DBSCAN Epsilon (m)</label>
                                <input type="number" id="dbscan_epsilon" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="500" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Max Cluster Radius (m)</label>
                                <input type="number" id="max_cluster_radius" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="800" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Min Cluster Size</label>
                                <input type="number" id="min_cluster_size" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="2" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Time Window (days)</label>
                                <input type="number" id="time_window_days" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="6" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Max Cluster Age (days)</label>
                                <input type="number" id="max_cluster_age" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="7" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Geocoding Threshold</label>
                                <input type="number" step="0.01" id="geocoding_threshold" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="0.85" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-0.5">Auto Accept Radius (m)</label>
                                <input type="number" id="auto_accept_radius" class="config-input w-full px-2 py-1 border border-gray-300 rounded text-xs bg-gray-100 cursor-not-allowed" value="200" disabled>
                            </div>
                            <button id="saveConfigBtn" onclick="saveConfiguration()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white py-1.5 px-3 rounded-lg text-xs font-medium transition-all shadow hover:shadow-md mt-2 opacity-50 cursor-not-allowed" disabled>Save Configuration</button>
                        </div>
                    </div>

                    <!-- Container 2 -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                        <h2 class="text-base font-bold text-gray-800 mb-4 pb-2 border-b border-gray-300">Container 2</h2>
                        <p class="text-sm text-gray-500">Content here</p>
                    </div>

                    <!-- Container 3 -->
                    <div class="bg-white rounded-lg shadow-md border border-gray-200 p-4">
                        <h2 class="text-base font-bold text-gray-800 mb-4 pb-2 border-b border-gray-300">Container 3</h2>
                        <p class="text-sm text-gray-500">Content here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Confirmation Modal (Replaces confirm()) -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
            <h3 id="confirmationTitle" class="text-xl font-bold text-danger mb-3">Confirm Action</h3>
            <p id="confirmationMessage" class="text-gray-700 mb-6">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelAction()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Cancel</button>
                <button onclick="confirmAction()" class="bg-danger hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Configuration Warning Modal -->
    <div id="editWarningModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
            <div class="flex items-center mb-4">
                <svg class="w-8 h-8 text-warning mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <h3 class="text-lg font-bold text-gray-800">Warning: Algorithm Configuration</h3>
            </div>
            <p class="text-sm text-gray-700 mb-6">Editing these settings will affect the overall clustering algorithm behavior. Changes may impact how clusters are detected and processed. Do you want to continue?</p>
            <div class="flex justify-end space-x-3">
                <button onclick="cancelEditWarning()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors text-sm">No, I don't want to</button>
                <button onclick="confirmEditWarning()" class="bg-warning hover:bg-yellow-600 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">Yes, I agree</button>
            </div>
        </div>
    </div>
</body>
</html>

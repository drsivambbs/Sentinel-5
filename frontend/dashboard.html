<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Sentinel-5 | ICMR-NIE</title>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: 'Roboto', sans-serif; background: #f8f9fa; overflow: hidden; }
    body { display: flex; }

    /* SIDEBAR */
    .sidebar { width: 220px; background: #003087; color: white; padding: 20px 0; position: fixed; height: 100%; box-shadow: 2px 0 12px rgba(0,0,0,0.08); }
    .sidebar-header { padding: 0 20px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-header .material-icons { font-size: 36px; margin-bottom: 6px; }
    .sidebar-header h2 { font-size: 18px; font-weight: 700; }
    .sidebar-header p { font-size: 12px; opacity: 0.8; }
    .sidebar-menu a { display: flex; align-items: center; padding: 12px 20px; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s; font-size: 14px; }
    .sidebar-menu a:hover, .sidebar-menu a.active { background: rgba(255,255,255,0.12); }
    .sidebar-menu .material-icons { margin-right: 10px; font-size: 18px; }
    .sidebar-logout { border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; }
    .sidebar-logout .logout { display: flex; align-items: center; padding: 12px 20px; color: white; text-decoration: none; font-weight: 500; transition: all 0.2s; font-size: 14px; }
    .sidebar-logout .logout:hover { background: rgba(255,255,255,0.12); }
    .sidebar-logout .material-icons { margin-right: 10px; font-size: 18px; }
    
    /* Upload in Bottom Container */
    .upload-container h3 { font-size: 16px; color: #003087; margin-bottom: 12px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .pending-container h2 { font-size: 16px; color: #003087; margin-bottom: 12px; text-align: center; font-weight: 600; }
    .upload-area { border: 2px dashed #003087; border-radius: 8px; padding: 16px; text-align: center; background: #f8fbff; cursor: pointer; transition: all 0.2s; }
    .upload-area:hover { background: #e6f0ff; border-color: #0056b3; }
    .upload-area .material-icons { font-size: 32px; color: #003087; margin-bottom: 8px; display: block; }
    .upload-area p { color: #666; font-size: 14px; margin: 0; }
    .upload-btn { margin-top: 12px; background: #003087; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 14px; cursor: pointer; transition: background 0.2s; width: 100%; }
    .upload-btn:hover { background: #0056b3; }
    .upload-btn:disabled { background: #ccc; cursor: not-allowed; }
    #uploadResult { margin-top: 12px; font-size: 13px; line-height: 1.4; }

    /* DASHBOARD LAYOUT */
    .main-content {
      margin-left: 220px; flex: 1; height: 100vh; padding: 16px; overflow-y: auto;
    }
    .dashboard-grid {
      display: grid; grid-template-columns: 320px 1fr 320px; gap: 16px; height: calc(100vh - 32px);
    }
    .col-left {
      display: flex; flex-direction: column; gap: 16px;
    }
    .pending-container {
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px; flex: 1;
    }
    .upload-container {
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px;
    }
    .col-middle {
      background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 20px;
    }





    /* RIGHT: Scrollable Pending Clusters */
    .col-right {
      width: 320px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      padding: 20px; display: flex; flex-direction: column;
    }
    .col-right h2 { font-size: 16px; color: #003087; margin-bottom: 12px; text-align: center; font-weight: 600; }
    .cluster-list {
      flex: 1; overflow-y: auto; padding-right: 6px;
    }
    .cluster-item {
      padding: 10px 12px; background: #f8fbff; border-radius: 8px; margin-bottom: 8px;
      border-left: 3px solid #003087; font-size: 13px; line-height: 1.4;
    }
    .cluster-item strong { color: #003087; font-size: 12px; }
    .status-pending { color: #e67e22; font-weight: 600; }
    .status-accepted { color: #27ae60; font-weight: 600; }
    .status-rejected { color: #c0392b; font-weight: 600; }

    /* Responsive fallback */
    @media (max-width: 1200px) {
      .main-content { flex-direction: column; padding: 20px; overflow-y: auto; }
      .col-left, .col-right, .col-middle { width: 100%; max-width: none; }
      .col-middle { order: -1; }
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="material-icons">shield</span>
      <h2>Sentinel-5</h2>
      <p>ICMR-NIE</p>
    </div>
    <div class="sidebar-menu">
      <a href="#" class="active"><span class="material-icons">dashboard</span><span>Dashboard Home</span></a>
      <a href="#"><span class="material-icons">people</span><span>Patient Records</span></a>
      <a href="#"><span class="material-icons">device_hub</span><span>Cluster Analysis</span></a>
      <a href="#"><span class="material-icons">assessment</span><span>Reports & Alerts</span></a>
      <a href="#"><span class="material-icons">settings</span><span>System Settings</span></a>
    </div>
    
    <!-- Logout at Bottom -->
    <div class="sidebar-logout">
      <a href="index.html" class="logout"><span class="material-icons">logout</span><span>Logout</span></a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div class="main-content">
    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      <!-- Left: Pending + Upload -->
      <div class="col-left">
        <!-- Pending Clusters -->
        <div class="pending-container">
          <h2>Pending Review (27)</h2>
          <div class="cluster-list">
            <div class="cluster-item"><strong>GIS_TN_CHE_FEV_22NOV2025_008</strong><br>Fever • 12 cases • <span class="status-pending">PENDING_MERGE</span></div>
            <div class="cluster-item"><strong>ABC_KA_BLR_DIA_22NOV2025_003</strong><br>Diarrhea • 9 cases • <span class="status-pending">PENDING_NEW</span></div>
            <div class="cluster-item"><strong>GIS_MH_MUM_JAU_21NOV2025_005</strong><br>Jaundice • 15 cases • <span class="status-pending">PENDING_MERGE</span></div>
          </div>
        </div>
        
        <!-- Upload -->
        <div class="upload-container">
          <h3><span class="material-icons">cloud_upload</span>Upload Patient Data</h3>
          <div class="upload-area" onclick="document.getElementById('csvFile').click()">
            <span class="material-icons">description</span>
            <p>Drop CSV file here or click to browse</p>
            <input type="file" id="csvFile" accept=".csv" style="display:none">
          </div>
          <button class="upload-btn" id="uploadBtn" disabled>Validate & Upload</button>
          <div id="uploadResult"></div>
        </div>
      </div>

      <!-- Middle: Empty -->
      <div class="col-middle">
        <!-- Empty for now -->
      </div>

      <!-- Right: Empty for now -->
      <div class="col-right">
        <!-- Empty -->
      </div>
    </div>
  </div>

  <!-- FULL CSV VALIDATION SCRIPT (your original logic) -->
  <script>
    let API_ENDPOINT = '';
    
    // Load API endpoint from .env
    fetch('.env')
      .then(response => response.text())
      .then(data => {
        const lines = data.split('\n');
        lines.forEach(line => {
          if (line.includes('API_ENDPOINT=')) {
            API_ENDPOINT = line.split('=')[1];
          }
        });
      })
      .catch(() => console.log('Env file not found'));
    const referenceSchema = [{"column_name":"patient_id","data_type":"INT64"},{"column_name":"site_code","data_type":"STRING"},{"column_name":"hospital_reg_id","data_type":"STRING"},{"column_name":"patient_entry_date","data_type":"DATE"},{"column_name":"pat_admi_location","data_type":"INT64"},{"column_name":"patient_name","data_type":"STRING"},{"column_name":"pat_mid_name","data_type":"STRING"},{"column_name":"pat_sodo","data_type":"STRING"},{"column_name":"pat_age","data_type":"INT64"},{"column_name":"pat_agemonths","data_type":"STRING"},{"column_name":"pat_agedays","data_type":"INT64"},{"column_name":"pat_sex","data_type":"INT64"},{"column_name":"pat_contact_his","data_type":"INT64"},{"column_name":"pat_health_worker","data_type":"INT64"},{"column_name":"pat_hw_contact","data_type":"INT64"},{"column_name":"pat_travel_his","data_type":"INT64"},{"column_name":"pat_travel_type","data_type":"INT64"},{"column_name":"pat_travel_int","data_type":"STRING"},{"column_name":"pat_travel_dom","data_type":"INT64"},{"column_name":"pat_country","data_type":"STRING"},{"column_name":"statename","data_type":"STRING"},{"column_name":"districtname","data_type":"STRING"},{"column_name":"subdistrictname","data_type":"STRING"},{"column_name":"villagename","data_type":"STRING"},{"column_name":"latitude","data_type":"FLOAT64"},{"column_name":"longitude","data_type":"FLOAT64"},{"column_name":"pat_street","data_type":"STRING"},{"column_name":"pat_house","data_type":"STRING"},{"column_name":"pat_pincode","data_type":"INT64"},{"column_name":"pat_areatype","data_type":"STRING"},{"column_name":"pat_occupation","data_type":"INT64"},{"column_name":"pat_occupation_others","data_type":"STRING"},{"column_name":"clini_date_illness","data_type":"STRING"},{"column_name":"clini_dura_days","data_type":"INT64"},{"column_name":"clini_primary_syn","data_type":"STRING"},{"column_name":"syndrome_other_p","data_type":"STRING"},{"column_name":"sym_fever","data_type":"BOOL"},{"column_name":"sym_new_onset_of_seizures","data_type":"BOOL"},{"column_name":"sym_dysentery","data_type":"BOOL"},{"column_name":"sym_jaundice","data_type":"BOOL"},{"column_name":"sym_papule_rash","data_type":"BOOL"},{"column_name":"sym_vomiting","data_type":"BOOL"},{"column_name":"sym_myalgia","data_type":"BOOL"},{"column_name":"sym_breathlessness","data_type":"BOOL"},{"column_name":"sym_sore_throat","data_type":"BOOL"},{"column_name":"sym_cough","data_type":"BOOL"},{"column_name":"sym_yellow_urine","data_type":"BOOL"},{"column_name":"sym_yellow_skin","data_type":"BOOL"},{"column_name":"sym_eschar","data_type":"STRING"},{"column_name":"sym_altered_sensorium","data_type":"BOOL"},{"column_name":"sym_increased_somnolence","data_type":"BOOL"},{"column_name":"sym_dark_urine","data_type":"BOOL"},{"column_name":"sym_yellow_sclera","data_type":"BOOL"},{"column_name":"sym_nausea","data_type":"BOOL"},{"column_name":"sym_irritability","data_type":"BOOL"},{"column_name":"sym_diarrhea","data_type":"BOOL"},{"column_name":"sym_neck_rigidity","data_type":"BOOL"},{"column_name":"sym_headache","data_type":"BOOL"},{"column_name":"sym_chills","data_type":"BOOL"},{"column_name":"sym_malaise","data_type":"BOOL"},{"column_name":"sym_discharge_eyes","data_type":"STRING"},{"column_name":"sym_arthralgia","data_type":"BOOL"},{"column_name":"sym_abdominal_pain","data_type":"BOOL"},{"column_name":"sym_redness_eyes","data_type":"BOOL"},{"column_name":"sym_retro_orb_pain","data_type":"BOOL"},{"column_name":"sym_other_symptom","data_type":"BOOL"},{"column_name":"symptom_other","data_type":"STRING"},{"column_name":"vit_pulse","data_type":"INT64"},{"column_name":"vit_bp_sys","data_type":"INT64"},{"column_name":"vit_bp_dia","data_type":"INT64"},{"column_name":"vit_temp","data_type":"INT64"},{"column_name":"vit_resp_rate","data_type":"INT64"},{"column_name":"vit_spo2","data_type":"INT64"},{"column_name":"vit_dehyd","data_type":"INT64"},{"column_name":"vit_icterus","data_type":"INT64"},{"column_name":"vit_edema","data_type":"INT64"},{"column_name":"vit_conj","data_type":"INT64"},{"column_name":"vit_conj_sub","data_type":"INT64"},{"column_name":"vit_eschar","data_type":"INT64"},{"column_name":"vit_eschar_value","data_type":"INT64"},{"column_name":"vit_cbc_done","data_type":"INT64"},{"column_name":"vit_cbc_hemat","data_type":"FLOAT64"},{"column_name":"vit_cbc_hb","data_type":"FLOAT64"},{"column_name":"vit_cbc_rbc","data_type":"FLOAT64"},{"column_name":"vit_cbc_wbc","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_n","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_l","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_m","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_e","data_type":"FLOAT64"},{"column_name":"vit_cbc_dc_b","data_type":"FLOAT64"},{"column_name":"vit_cbc_esr","data_type":"FLOAT64"},{"column_name":"vit_cbc_plat","data_type":"INT64"},{"column_name":"vit_lf_done","data_type":"INT64"},{"column_name":"vit_lf_al","data_type":"FLOAT64"},{"column_name":"vit_lf_pro","data_type":"FLOAT64"},{"column_name":"vit_lf_ast","data_type":"FLOAT64"},{"column_name":"vit_lf_alt","data_type":"FLOAT64"},{"column_name":"vit_lf_ggt","data_type":"INT64"},{"column_name":"vit_lf_bil_d","data_type":"FLOAT64"},{"column_name":"vit_lf_bil_i","data_type":"FLOAT64"},{"column_name":"vit_lf_bil_t","data_type":"FLOAT64"},{"column_name":"vit_rf_done","data_type":"INT64"},{"column_name":"vit_rf_urea","data_type":"FLOAT64"},{"column_name":"vit_rf_creat","data_type":"FLOAT64"},{"column_name":"vit_rf_chl","data_type":"FLOAT64"},{"column_name":"vit_rf_sod","data_type":"FLOAT64"},{"column_name":"vit_rf_pot","data_type":"FLOAT64"},{"column_name":"vit_rf_uric","data_type":"FLOAT64"},{"column_name":"vit_rf_cal","data_type":"FLOAT64"},{"column_name":"vit_rf_urea_r","data_type":"INT64"},{"column_name":"vit_apr_done","data_type":"INT64"},{"column_name":"vit_apr_crp","data_type":"FLOAT64"},{"column_name":"vit_apr_ldh","data_type":"FLOAT64"},{"column_name":"vit_apr_ddimer","data_type":"FLOAT64"},{"column_name":"vit_apr_ferr","data_type":"FLOAT64"},{"column_name":"vit_apr_tferr","data_type":"FLOAT64"},{"column_name":"vit_apr_proca","data_type":"FLOAT64"},{"column_name":"vit_diag","data_type":"STRING"},{"column_name":"vit_comorbid","data_type":"INT64"},{"column_name":"vit_comorbid_others","data_type":"STRING"},{"column_name":"vit_icu_shift","data_type":"INT64"},{"column_name":"vit_icu_duration","data_type":"INT64"},{"column_name":"vit_outcome","data_type":"INT64"},{"column_name":"vit_death_cause","data_type":"STRING"},{"column_name":"vit_discharge_date","data_type":"STRING"}];
    const requiredColumns = referenceSchema.map(c => c.column_name);

    const fileInput = document.getElementById('csvFile');
    const uploadBtn = document.getElementById('uploadBtn');
    const resultDiv = document.getElementById('uploadResult');

    fileInput.addEventListener('change', () => {
      uploadBtn.disabled = !fileInput.files.length;
      resultDiv.textContent = fileInput.files.length ? `Selected: ${fileInput.files[0].name}` : '';
    });

    uploadBtn.addEventListener('click', () => {
      const file = fileInput.files[0];
      resultDiv.innerHTML = '<p style="color:#003087">Validating...</p>';
      uploadBtn.disabled = true;

      const reader = new FileReader();
      reader.onload = e => {
        const parsed = Papa.parse(e.target.result, { header: true, skipEmptyLines: true });
        const headers = parsed.meta.fields || [];
        const errors = [];
        headers.forEach(h => { if (!requiredColumns.includes(h)) errors.push(`Unknown: ${h}`); });
        requiredColumns.forEach(req => { if (!headers.includes(req)) errors.push(`Missing: ${req}`); });

        if (errors.length) {
          resultDiv.innerHTML = `<p style="color:red">Failed:</p><ul style="font-size:12px;text-align:left"><li>${errors.slice(0,10).join('</li><li>')}${errors.length>10?'...':''}</li></ul>`;
          uploadBtn.disabled = false;
          return;
        }

        // Process rows exactly like csv_validate.js
        const rows = parsed.data.map(r => {
          r.latitude = '';
          r.longitude = '';
          
          const addressParts = [
            r.pat_house || '',
            r.pat_street || '',
            r.villagename || '',
            r.subdistrictname || '',
            r.districtname || '',
            r.statename || '',
            r.pat_pincode || ''
          ].filter(part => part.trim()).join(' | ');
          
          r.complete_address_column = addressParts;
          r.unique_id = `${r.patient_id || ''}_${r.site_code || ''}_${r.patient_entry_date || ''}`;
          return r;
        });
        
        // Deduplication by unique_id
        const seenIds = new Set();
        const clean = rows.filter(r => {
          if (seenIds.has(r.unique_id)) return false;
          seenIds.add(r.unique_id);
          return true;
        });
        const dupes = rows.length - clean.length;

        const form = new FormData();
        form.append('file', new File([Papa.unparse(clean)], `validated_${file.name}`, {type:'text/csv'}));

        resultDiv.innerHTML = `<p style="color:#003087">Uploading ${clean.length} records (removed ${dupes} duplicates)...</p>`;

        fetch('https://sentinel-upload-service-196547645490.asia-south1.run.app/upload', { method: 'POST', body: form })
          .then(r => r.json())
          .then(d => {
            resultDiv.innerHTML = `<p style="color:green">Uploaded!</p><small>${d.fileName || 'processed'}</small>`;
            fileInput.value = '';
          })
          .catch(err => resultDiv.innerHTML = `<p style="color:red">Failed: ${err.message}</p>`)
          .finally(() => uploadBtn.disabled = false);
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>